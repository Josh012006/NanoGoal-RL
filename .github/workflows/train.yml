name: Train models

on:
  push:
  pull_request:

permissions:
  contents: write
  issues: write

jobs:
  train:
    runs-on: [self-hosted, linux, cpu]
    timeout-minutes: 7200

    env:
      VENV: .venv/bin

    steps:
      - name: Fetch code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}

      - name: Read train.flag
        id: read_flag
        run: |
          set -e

          FLAG_FILE=".github/ci/train.flag"

          if [ ! -f "$FLAG_FILE" ]; then
            echo "train=false" >> "$GITHUB_OUTPUT"
            echo "train_easy=false" >> "$GITHUB_OUTPUT"
            echo "train_medium=false" >> "$GITHUB_OUTPUT"
            echo "train_hard=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          while IFS='=' read -r key value; do
            [ -z "$key" ] && continue
            case "$key" in
              train) echo "train=$value" >> "$GITHUB_OUTPUT" ;;
              train_easy) echo "train_easy=$value" >> "$GITHUB_OUTPUT" ;;
              train_medium) echo "train_medium=$value" >> "$GITHUB_OUTPUT" ;;
              train_hard) echo "train_hard=$value" >> "$GITHUB_OUTPUT" ;;
            esac
          done < "$FLAG_FILE"

      - name: Stop job if training is disabled
        if: steps.read_flag.outputs.train == 'false'
        run: |
          echo "Training disabled â†’ stopping job"
          exit 0

      - name: Install dependencies
        if: steps.read_flag.outputs.train == 'true'
        run: |
          set -e
          python3 -m venv .venv
          $VENV/python -m pip install --upgrade pip
          $VENV/python -m pip install -r requirements.txt

      - name: Prepare environment
        if: steps.read_flag.outputs.train == 'true'
        run: |
          set -e
          mkdir -p plots/easy plots/medium plots/hard
          rm -rf logs
          mkdir -p logs

      - name: Train easy model
        if: steps.read_flag.outputs.train == 'true' && steps.read_flag.outputs.train_easy == 'true'
        run: |
          set -e
          $VENV/python train_easy.py
          $VENV/python eval.py 0 0
          $VENV/python eval.py 0 1
          $VENV/python eval.py 0 2
          $VENV/python saving_plots.py results/easy/ppo_eval_easy.csv plots/easy 0
          $VENV/python saving_plots.py results/easy/ppo_eval_medium.csv plots/easy 1 0
          $VENV/python saving_plots.py results/easy/ppo_eval_hard.csv plots/easy 2 0

      - name: Train medium model
        if: steps.read_flag.outputs.train == 'true' && steps.read_flag.outputs.train_medium == 'true'
        run: |
          set -e
          $VENV/python train_medium.py
          $VENV/python eval.py 1 0
          $VENV/python eval.py 1 1
          $VENV/python eval.py 1 2
          $VENV/python saving_plots.py results/medium/ppo_eval_easy.csv plots/medium 0 0
          $VENV/python saving_plots.py results/medium/ppo_eval_medium.csv plots/medium 1
          $VENV/python saving_plots.py results/medium/ppo_eval_hard.csv plots/medium 2 0

      - name: Train hard model
        if: steps.read_flag.outputs.train == 'true' && steps.read_flag.outputs.train_hard == 'true'
        run: |
          set -e
          $VENV/python train_hard.py
          $VENV/python eval.py 2 0
          $VENV/python eval.py 2 1
          $VENV/python eval.py 2 2
          $VENV/python saving_plots.py results/hard/ppo_eval_easy.csv plots/hard 0 0
          $VENV/python saving_plots.py results/hard/ppo_eval_medium.csv plots/hard 1 0
          $VENV/python saving_plots.py results/hard/ppo_eval_hard.csv plots/hard 2

      - name: Commit & push changes
        if: steps.read_flag.outputs.train == 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -e

          FLAG_FILE=".github/ci/train.flag"
          {
            echo "train=false"
            echo "train_easy=false"
            echo "train_medium=false"
            echo "train_hard=false"
          } > "$FLAG_FILE"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          SHA="$GITHUB_SHA"
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            SHA="$(jq -r .pull_request.head.sha "$GITHUB_EVENT_PATH")"
          fi

          git add .

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "feat: Trained models after commit of ID: $SHA [skip ci]"

          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            git push \
              https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git \
              "HEAD:${GITHUB_REF_NAME}"
            exit 0
          fi

          IS_FORK="$(jq -r .pull_request.head.repo.fork "$GITHUB_EVENT_PATH")"
          if [ "$IS_FORK" = "true" ]; then
            echo "PR from fork: skipping push."
            exit 0
          fi

          git push \
            https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git \
            "HEAD:${GITHUB_HEAD_REF}"

      - name: Create issue
        if: steps.read_flag.outputs.train == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          SHA="$GITHUB_SHA"
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            SHA="$(jq -r .pull_request.head.sha "$GITHUB_EVENT_PATH")"
          fi

          gh issue create \
            --title "Training finished for $SHA" \
            --body $'- [ ] Generate and review training metrics\n- [ ] Validate model performance\n- [ ] Make video demos of the models performance\n- [ ] Update README\n\nModels trained from commit: '"$SHA"
